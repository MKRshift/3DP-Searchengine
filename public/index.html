<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Meta Search</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --shadow2: 0 10px 26px rgba(0,0,0,.10);
      --r: 14px;
      --r2: 18px;
      --accent:#10b981;
      --accent2:#0ea5e9;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: var(--bg);
    }
    a{color:inherit}

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(246,247,249,.92);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }
    .container{max-width:1320px; margin:0 auto; padding: 0 18px;}
    .head{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 14px 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .mark{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 25%, rgba(52,211,153,1), rgba(16,185,129,1) 58%, rgba(14,165,233,1));
      box-shadow: 0 10px 20px rgba(16,185,129,.22);
    }
    .brandText{line-height:1.05}
    .brandText b{font-weight: 950; letter-spacing:.2px; display:block}
    .brandText small{color:var(--muted); font-size: 11px; display:block; margin-top:2px}

    .searchbar{flex:1; display:flex; align-items:center; gap:10px;}
    .searchbox{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: var(--panel);
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }
    .mag{
      width: 18px; height:18px;
      opacity: .65;
      background: conic-gradient(from 180deg, var(--accent), var(--accent2));
      -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18Zm11.707 2.293-5.387-5.387a10 10 0 1 0-1.414 1.414l5.387 5.387a1 1 0 0 0 1.414-1.414Z"/></svg>') center/contain no-repeat;
              mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18Zm11.707 2.293-5.387-5.387a10 10 0 1 0-1.414 1.414l5.387 5.387a1 1 0 0 0 1.414-1.414Z"/></svg>') center/contain no-repeat;
    }
    .searchbox input{
      flex:1;
      border:0;
      outline:0;
      background:transparent;
      font-size: 14px;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: #f9fafb;
      color: #374151;
      user-select:none;
    }

    .btn{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover{box-shadow: 0 10px 24px rgba(0,0,0,.06)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(16,185,129,.35);
      background: linear-gradient(180deg, #10b981, #059669);
      color: white;
    }

    .select{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
      cursor:pointer;
    }

    .layout{
      max-width:1320px;
      margin:0 auto;
      padding: 16px 18px 60px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
      .brand{min-width:unset;}
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
    }

    .sidebar{padding: 12px;}
    .sidebar h2{margin: 0 0 6px; font-size: 13px; letter-spacing:.2px}
    .sidebar .sub{color: var(--muted); font-size: 12px; line-height:1.35}

    .sourceList{display:flex; flex-direction:column; gap:6px; margin-top: 12px;}
    .sourceRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 10px;
      border-radius: 14px;
      border:1px solid transparent;
    }
    .sourceRow:hover{background:#f3f4f6; border-color: var(--border)}
    .sourceRow input{width:16px; height:16px; accent-color: var(--accent); cursor:pointer}
    .fav{
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      object-fit:cover;
      flex: 0 0 auto;
    }
    .sourceMeta{display:flex; flex-direction:column; line-height:1.05;}
    .sourceMeta b{font-size: 12px; font-weight: 900}
    .sourceMeta small{font-size: 11px; color: var(--muted)}
    .hint{
      margin-left:auto;
      font-family: var(--mono);
      font-size: 10.5px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:#374151;
    }
    .hint.ok{border-color: rgba(16,185,129,.35); color:#065f46; background: rgba(16,185,129,.08)}
    .hint.warn{border-color: rgba(244,63,94,.35); color:#9f1239; background: rgba(244,63,94,.08)}
    .hint.link{border-color: rgba(59,130,246,.35); color:#1d4ed8; background: rgba(59,130,246,.07)}

    .main{}

    .mainTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 0;
      flex-wrap:wrap;
    }
    .mainTop h1{margin:0; font-size: 16px; font-weight: 950;}
    .metaLine{color: var(--muted); font-size: 12px;}

    .quickLinks{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 10px 12px 12px;
      border-bottom: 1px solid var(--border);
    }
    .qchip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background:#fff;
      text-decoration:none;
      font-size: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.03);
    }
    .qchip:hover{box-shadow: 0 10px 22px rgba(0,0,0,.06)}
    .qchip img{width:16px; height:16px; border-radius: 5px; border:1px solid rgba(0,0,0,.10)}
    .qchip .tiny{font-family: var(--mono); font-size: 10.5px; color: var(--muted)}

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
      padding: 12px;
    }

    .card{
      display:block;
      border:1px solid var(--border);
      border-radius: var(--r2);
      overflow:hidden;
      background:#fff;
      text-decoration:none;
      box-shadow: 0 6px 16px rgba(0,0,0,.05);
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .card:hover{transform: translateY(-2px); box-shadow: var(--shadow2)}

    .thumb{
      position:relative;
      width:100%;
      padding-top: 68%;
      background:
        radial-gradient(800px 300px at 15% 15%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(800px 300px at 85% 20%, rgba(14,165,233,.14), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.02), rgba(0,0,0,.00));
      background-size: cover;
      background-position: center;
    }
    .siteIcon{
      position:absolute;
      top:10px;
      left:10px;
      width:28px;
      height:28px;
      border-radius: 10px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 16px rgba(0,0,0,.10);
    }
    .siteIcon img{width:18px; height:18px; border-radius: 6px;}

    .body{padding: 10px 12px 12px; display:flex; flex-direction:column; gap:8px;}
    .title{
      font-weight: 950;
      font-size: 13.4px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      min-height: 34px;
    }
    .byline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: var(--muted);
    }
    .author{
      display:-webkit-box;
      -webkit-line-clamp:1;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .sourceTag{
      font-family: var(--mono);
      font-size: 10.5px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:#374151;
      flex:0 0 auto;
    }
    .statsRow{display:flex; flex-wrap:wrap; gap:10px; font-size: 12px; color:#374151;}
    .stat{display:inline-flex; align-items:center; gap:6px;}
    .muted{color: var(--muted)}

    .empty{
      padding: 18px 12px;
      color: var(--muted);
      text-align:center;
    }

    .errorBox{
      margin: 12px;
      border:1px solid rgba(244,63,94,.30);
      background: rgba(244,63,94,.08);
      border-radius: var(--r2);
      padding: 10px 12px;
      color:#9f1239;
    }
    .errorBox h3{margin:0 0 6px; font-size: 13px}
    .errorBox ul{margin:0; padding-left: 18px;}

    .skeleton{pointer-events:none;}
    .shimmer{
      background: linear-gradient(90deg, #f3f4f6, #e5e7eb, #f3f4f6);
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 0% 0}
      100%{background-position: -200% 0}
    }
    .skeleton .thumb{background: #f3f4f6;}
    .skeleton .title, .skeleton .byline, .skeleton .statsRow{color:transparent}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="head">
        <div class="brand">
          <div class="mark" aria-hidden="true"></div>
          <div class="brandText">
            <b>3D Meta Search</b>
            <small>Multi-site search + MakerWorld-ish cards</small>
          </div>
        </div>

        <form id="form" class="searchbar" autocomplete="off">
          <div class="searchbox">
            <span class="mag" aria-hidden="true"></span>
            <input id="q" type="text" placeholder="Search models (e.g. cyber, mech spider, kit card‚Ä¶)" />
            <span class="kbd">Enter</span>
          </div>
          <select id="sort" class="select" title="Sort">
            <option value="relevant">Relevance</option>
            <option value="newest">Newest (best-effort)</option>
            <option value="likes">Likes</option>
            <option value="downloads">Downloads / Collections</option>
            <option value="views">Views</option>
          </select>
          <button class="btn primary" type="submit">Search</button>
        </form>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="panel sidebar">
      <h2>Filters</h2>
      <div class="sub">Pick sources. <span class="hint ok">‚úÖ</span> works now, <span class="hint warn">‚ö†Ô∏è</span> needs a key, <span class="hint link">üîó</span> link-only.</div>

      <div class="sourceList" id="sources"></div>
    </aside>

    <main class="panel main">
      <div class="mainTop">
        <h1 id="title">Models</h1>
        <div class="metaLine" id="status">Ready.</div>
      </div>

      <div class="quickLinks" id="quick" style="display:none"></div>

      <div id="errors" style="display:none"></div>
      <div class="grid" id="grid"></div>
    </main>
  </div>

<script>
  const $ = (s) => document.querySelector(s);
  const grid = $("#grid");
  const status = $("#status");
  const titleEl = $("#title");
  const quickEl = $("#quick");
  const errorsBox = $("#errors");
  const sourcesEl = $("#sources");
  const qInput = $("#q");
  const form = $("#form");
  const sortSel = $("#sort");

  let sources = [];
  let sourceMap = new Map();
  let selected = new Set();
  let lastController = null;
  let debounce = null;

  const MASK_ORDER = [
    "printables",
    "thangs",
    "makerworld",
    "thingiverse",
    "mmf",
    "cults",
    "sketchfab",
    "cgtrader",
    "turbosquid",
  ];

  function esc(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function fmt(n){
    const x = Number(n);
    if (!Number.isFinite(x) || x <= 0) return null;
    if (x >= 1_000_000) return (x/1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
    if (x >= 1_000) return (x/1_000).toFixed(1).replace(/\.0$/, "") + "k";
    return String(Math.round(x));
  }

  function getMaskIds(){
    const ids = [];
    for (const id of MASK_ORDER) if (sourceMap.has(id)) ids.push(id);
    for (const s of sources) if (!ids.includes(s.id)) ids.push(s.id);
    return ids;
  }

  function maskFromSelected(){
    const ids = getMaskIds();
    let m = 0;
    for (let i=0;i<ids.length;i++){
      if (selected.has(ids[i])) m |= (1 << i);
    }
    return m >>> 0;
  }

  function applyMask(mask){
    const ids = getMaskIds();
    selected = new Set();
    for (let i=0;i<ids.length;i++){
      if (mask & (1 << i)) selected.add(ids[i]);
    }
    // if mask decodes to empty, fall back to "all"
    if (selected.size === 0) {
      for (const s of sources) selected.add(s.id);
    }
  }

  function selectedCsv(){
    return Array.from(selected).join(",");
  }

  function setUrlState({ keyword, sort }){
    const url = new URL(window.location.href);
    url.pathname = "/search/models";
    url.searchParams.set("keyword", keyword);
    url.searchParams.set("sort", sort);
    url.searchParams.set("w", String(maskFromSelected()));
    window.history.replaceState({}, "", url);
  }

  function readUrlState(){
    const url = new URL(window.location.href);
    const keyword = url.searchParams.get("keyword") || url.searchParams.get("q") || "";
    const sort = (url.searchParams.get("sort") || "relevant").toLowerCase();
    const w = url.searchParams.get("w");
    const sourcesParam = url.searchParams.get("sources");
    return { keyword, sort, w, sourcesParam };
  }

  function hintForSource(s){
    if ((s.kind || "api") === "link") return { cls: "link", text: "üîó" };
    if (s.configured || s.id === "sketchfab") return { cls: "ok", text: "‚úÖ" };
    return { cls: "warn", text: "‚ö†Ô∏è" };
  }

  function renderSources(){
    sourcesEl.innerHTML = sources.map((s) => {
      const checked = selected.has(s.id) ? "checked" : "";
      const hint = hintForSource(s);
      const note = s.notes ? s.notes : ((s.kind || "api") === "link" ? "Link-only" : (s.configured ? "Configured" : "Needs key"));
      const icon = s.iconUrl ? `<img class="fav" src="${esc(s.iconUrl)}" alt="" loading="lazy" />` : `<span class="fav" style="display:inline-block"></span>`;

      return `
        <label class="sourceRow" title="${esc(note)}">
          <input type="checkbox" data-id="${esc(s.id)}" ${checked} />
          ${icon}
          <span class="sourceMeta">
            <b>${esc(s.label)}</b>
            <small>${esc(note)}</small>
          </span>
          <span class="hint ${hint.cls}">${hint.text}</span>
        </label>
      `;
    }).join("");

    sourcesEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", (e) => {
        const id = e.target.dataset.id;
        if (e.target.checked) selected.add(id); else selected.delete(id);

        // keep URL synced (3Drop-like `w=` bitmask)
        setUrlState({ keyword: qInput.value.trim() || "", sort: sortSel.value });

        // if we already have a query, re-run (fast + cancels previous)
        const q = qInput.value.trim();
        if (q) doSearch(q, { pushUrl: false });
      });
    });
  }

  function renderQuickLinks(quickLinks){
    const list = Array.isArray(quickLinks) ? quickLinks : [];
    if (!list.length) {
      quickEl.style.display = "none";
      quickEl.innerHTML = "";
      return;
    }

    quickEl.style.display = "flex";
    quickEl.innerHTML = list.map((l) => {
      const icon = l.iconUrl ? `<img src="${esc(l.iconUrl)}" alt="" loading="lazy" />` : "";
      const kind = l.kind || "api";
      const tiny = kind === "link" ? "open" : "open";
      return `
        <a class="qchip" href="${esc(l.url)}" target="_blank" rel="noreferrer">
          ${icon}
          <span>${esc(l.label || l.source)}</span>
          <span class="tiny">${esc(tiny)}</span>
        </a>
      `;
    }).join("");
  }

  function statPill(icon, value, title){
    if (value === null || value === undefined) return "";
    const f = fmt(value);
    if (!f) return "";
    return `<span class="stat" title="${esc(title)}"><span>${icon}</span><span>${esc(f)}</span></span>`;
  }

  function cardTemplate(item){
    const title = esc(item.title || "Untitled");
    const author = esc(item.author || "");
    const url = item.url || "#";
    const thumb = item.thumbnail ? `background-image:url('${esc(item.thumbnail)}');` : "";
    const srcLabel = esc(item.sourceLabel || item.source || "");
    const iconUrl = item.sourceIconUrl || (sourceMap.get(item.source)?.iconUrl ?? null);
    const icon = iconUrl ? `<div class="siteIcon" title="${srcLabel}"><img src="${esc(iconUrl)}" alt="" loading="lazy" /></div>` : "";

    const m = item.meta || {};
    const likes = (m.likes ?? null);
    const downloads = (m.downloads ?? m.download_count ?? m.collects ?? null);
    const views = (m.views ?? m.visits ?? null);
    const rating = (m.rating ?? null);

    const stats = [
      statPill("‚ù§Ô∏è", likes, "Likes"),
      statPill("‚¨áÔ∏è", downloads, "Downloads / Collections"),
      statPill("üëÅ", views, "Views"),
      statPill("‚≠ê", rating, "Rating"),
    ].filter(Boolean).join("");

    const statsRow = stats ? `<div class="statsRow">${stats}</div>` : `<div class="statsRow"><span class="muted">No stats from this source</span></div>`;

    return `
      <a class="card" href="${esc(url)}" target="_blank" rel="noopener noreferrer">
        <div class="thumb" style="${thumb}">${icon}</div>
        <div class="body">
          <div class="title">${title}</div>
          <div class="byline">
            <span class="author">${author ? author : ""}</span>
            <span class="sourceTag">${srcLabel}</span>
          </div>
          ${statsRow}
        </div>
      </a>
    `;
  }

  function render(items){
    if (!items || !items.length) {
      grid.innerHTML = `<div class="empty">No results yet. Try a different keyword (or enable more sources).</div>`;
      return;
    }
    grid.innerHTML = items.map(cardTemplate).join("");
  }

  function renderSkeleton(){
    const cards = [];
    for (let i=0;i<12;i++){
      cards.push(`
        <div class="card skeleton">
          <div class="thumb shimmer"></div>
          <div class="body">
            <div class="title shimmer">&nbsp;</div>
            <div class="byline shimmer">&nbsp;</div>
            <div class="statsRow shimmer">&nbsp;</div>
          </div>
        </div>
      `);
    }
    grid.innerHTML = cards.join("");
  }

  function renderErrors(errors){
    if (!errors || !errors.length) {
      errorsBox.style.display = "none";
      errorsBox.innerHTML = "";
      return;
    }
    errorsBox.style.display = "block";
    errorsBox.className = "errorBox";
    errorsBox.innerHTML = `
      <h3>‚ö†Ô∏è Provider errors (partial results still shown)</h3>
      <ul>${errors.map(e => `<li><b>${esc(e.source)}</b>: ${esc(e.message)}</li>`).join("")}</ul>
    `;
  }

  async function doSearch(query, { pushUrl = true } = {}){
    if (!query) return;

    if (pushUrl) setUrlState({ keyword: query, sort: sortSel.value });

    // cancel previous request
    if (lastController) lastController.abort();
    lastController = new AbortController();

    renderSkeleton();
    renderErrors([]);

    const url = new URL("/api/search", window.location.origin);
    url.searchParams.set("q", query);
    url.searchParams.set("limit", "48");
    url.searchParams.set("sort", sortSel.value);
    if (selected.size) url.searchParams.set("sources", selectedCsv());

    const t0 = performance.now();
    status.textContent = "Searching‚Ä¶";

    try{
      const res = await fetch(url.toString(), { signal: lastController.signal });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Search failed");

      renderQuickLinks(data.quickLinks || []);
      render(data.results || []);
      renderErrors(data.errors || []);

      const took = Math.max(0, Math.round(performance.now() - t0));
      const count = Number(data.count || 0);
      const srcs = Array.isArray(data.sources) ? data.sources.length : 0;
      titleEl.textContent = `Models (${count})`;
      status.textContent = `${count} results ‚Ä¢ ${srcs} API source(s) ‚Ä¢ ${took}ms`;

      document.title = `3D Meta Search ‚Äî ${query}`;
    }catch(err){
      if (err.name === "AbortError") return;
      titleEl.textContent = "Models";
      status.textContent = `‚ö†Ô∏è ${err.message}`;
      grid.innerHTML = `<div class="empty">Search failed. Check your tokens/keys for the sources marked ‚ö†Ô∏è.</div>`;
    }
  }

  async function loadSources(){
    const res = await fetch("/api/sources");
    const data = await res.json();
    sources = Array.isArray(data.sources) ? data.sources : [];

    // stable order: MASK_ORDER first, then remaining
    const order = getMaskIds();
    sources.sort((a,b) => order.indexOf(a.id) - order.indexOf(b.id));

    sourceMap = new Map(sources.map(s => [s.id, s]));

    // default selection: all link providers + configured + Sketchfab
    selected = new Set(
      sources
        .filter(s => (s.kind || "api") === "link" || s.configured || s.id === "sketchfab")
        .map(s => s.id)
    );

    // apply URL selection if present
    const st = readUrlState();
    if (st.sourcesParam) {
      selected = new Set(st.sourcesParam.split(",").map(x => x.trim()).filter(Boolean));
    }
    if (st.w !== null && st.w !== undefined) {
      const m = parseInt(st.w, 10);
      if (Number.isFinite(m)) applyMask(m);
    }

    renderSources();
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const q = qInput.value.trim();
    if (q) doSearch(q);
  });

  sortSel.addEventListener("change", () => {
    const q = qInput.value.trim();
    setUrlState({ keyword: q || "", sort: sortSel.value });
    if (q) doSearch(q, { pushUrl: false });
  });

  qInput.addEventListener("input", () => {
    clearTimeout(debounce);
    const q = qInput.value.trim();
    // debounced "as-you-type" search to feel like MakerWorld / 3Drop
    debounce = setTimeout(() => {
      if (q.length >= 2) doSearch(q);
    }, 420);
  });

  qInput.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      qInput.value = "";
      qInput.blur();
      setUrlState({ keyword: "", sort: sortSel.value });
      titleEl.textContent = "Models";
      status.textContent = "Ready.";
      quickEl.style.display = "none";
      quickEl.innerHTML = "";
      errorsBox.style.display = "none";
      grid.innerHTML = `<div class="empty">Type a keyword to search.</div>`;
    }
  });

  (async function boot(){
    await loadSources();

    const st = readUrlState();
    if (st.sort) sortSel.value = st.sort;

    const initial = (st.keyword || "mech spider").trim();
    qInput.value = initial;

    // keep URL synced to MakerWorld-ish format
    setUrlState({ keyword: initial, sort: sortSel.value });

    doSearch(initial, { pushUrl: false });
  })();
</script>
</body>
</html>
